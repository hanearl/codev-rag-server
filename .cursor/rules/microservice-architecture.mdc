---
description: 
globs: 
alwaysApply: true
---
# RAG ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ì•„í‚¤í…ì²˜ ê°€ì´ë“œ

## ğŸ¯ í”„ë¡œì íŠ¸ ê°œìš”
RAG(Retrieval-Augmented Generation) ì‹œìŠ¤í…œì„ ìœ„í•œ ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ì•„í‚¤í…ì²˜ì—ì„œ ê° ì„œë¹„ìŠ¤ë³„ ì¼ê´€ì„± ìˆëŠ” ë””ë ‰í† ë¦¬ êµ¬ì¡°ì™€ ê°œë°œ ê·œì¹™ì„ ì •ì˜í•©ë‹ˆë‹¤.

## ğŸ—ï¸ ì „ì²´ í”„ë¡œì íŠ¸ êµ¬ì¡°

```
codev-rag-server/
â”œâ”€â”€ embedding-server/           â† ì„ë² ë”© ìƒì„± ì„œë¹„ìŠ¤
â”‚   â”œâ”€â”€ app/
â”‚   â”‚   â”œâ”€â”€ features/
â”‚   â”‚   â”œâ”€â”€ core/
â”‚   â”‚   â”œâ”€â”€ db/
â”‚   â”‚   â””â”€â”€ main.py
â”‚   â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ Dockerfile
â”‚   â””â”€â”€ requirements.txt
â”œâ”€â”€ llm-server/                 â† LLM ì¶”ë¡  ì„œë¹„ìŠ¤
â”‚   â”œâ”€â”€ app/
â”‚   â”‚   â”œâ”€â”€ features/
â”‚   â”‚   â”œâ”€â”€ core/
â”‚   â”‚   â”œâ”€â”€ db/
â”‚   â”‚   â””â”€â”€ main.py
â”‚   â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ Dockerfile
â”‚   â””â”€â”€ requirements.txt
â”œâ”€â”€ rag-server/                 â† RAG ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜ ì„œë¹„ìŠ¤
â”‚   â”œâ”€â”€ app/
â”‚   â”‚   â”œâ”€â”€ features/
â”‚   â”‚   â”œâ”€â”€ core/
â”‚   â”‚   â”œâ”€â”€ db/
â”‚   â”‚   â””â”€â”€ main.py
â”‚   â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ Dockerfile
â”‚   â””â”€â”€ requirements.txt
â”œâ”€â”€ vector-db/                  â† ë²¡í„° ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì •
â”‚   â””â”€â”€ config/
â”œâ”€â”€ docker-compose.yml
â”œâ”€â”€ docker-compose.dev.yml
â””â”€â”€ README.md
```

## ğŸ“¦ ê° ì„œë¹„ìŠ¤ë³„ ë””ë ‰í† ë¦¬ êµ¬ì¡°

ëª¨ë“  FastAPI ì„œë¹„ìŠ¤(`embedding-server`, `llm-server`, `rag-server`)ëŠ” ë™ì¼í•œ ë‚´ë¶€ êµ¬ì¡°ë¥¼ ê°€ì ¸ì•¼ í•©ë‹ˆë‹¤:

```
{service-name}/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ features/             â† ëª¨ë“  ë¹„ì¦ˆë‹ˆìŠ¤ ê¸°ëŠ¥ì„ í¬í•¨í•˜ëŠ” íŒ¨í‚¤ì§€
â”‚   â”‚   â”œâ”€â”€ <feature>/        â† ë„ë©”ì¸ ë˜ëŠ” ê¸°ëŠ¥ëª…
â”‚   â”‚   â”‚   â”œâ”€â”€ router.py     â† API ë¼ìš°í„°
â”‚   â”‚   â”‚   â”œâ”€â”€ service.py    â† ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
â”‚   â”‚   â”‚   â”œâ”€â”€ schema.py     â† ìš”ì²­/ì‘ë‹µ Pydantic ìŠ¤í‚¤ë§ˆ
â”‚   â”‚   â”‚   â”œâ”€â”€ model.py      â† ORM ëª¨ë¸ (í•„ìš”ì‹œ)
â”‚   â”‚   â”‚   â”œâ”€â”€ repository.py â† DB ì ‘ê·¼ ë¡œì§ (í•„ìš”ì‹œ)
â”‚   â”‚   â”‚   â””â”€â”€ __init__.py
â”‚   â”‚   â””â”€â”€ __init__.py       â† Features íŒ¨í‚¤ì§€ ì´ˆê¸°í™”
â”‚   â”œâ”€â”€ core/                 â† ì„¤ì •, ë³´ì•ˆ, ì˜ì¡´ì„± ì£¼ì…
â”‚   â”œâ”€â”€ db/                   â† DB ì´ˆê¸°í™” ë° session (í•„ìš”ì‹œ)
â”‚   â””â”€â”€ main.py               â† FastAPI app entrypoint
â”œâ”€â”€ tests/                    â† ì„œë¹„ìŠ¤ë³„ í…ŒìŠ¤íŠ¸
â”‚   â”œâ”€â”€ unit/
â”‚   â”œâ”€â”€ integration/
â”‚   â””â”€â”€ conftest.py
â”œâ”€â”€ Dockerfile                â† ì»¨í…Œì´ë„ˆ ë¹Œë“œ ì„¤ì •
â””â”€â”€ requirements.txt          â† Python ì˜ì¡´ì„±
```

## ğŸ›  íŒŒì¼ë³„ êµ¬ì¡° ê·œì¹™

### Router íŒŒì¼ (`{service}/app/features/**/router.py`)
- **í•„ìˆ˜ í¬í•¨**: FastAPI APIRouter ì¸ìŠ¤í„´ìŠ¤
- **í‘œì¤€ êµ¬ì¡°**:
```python
from fastapi import APIRouter

router = APIRouter(prefix="/api/v1", tags=["feature-name"])

@router.get("/endpoint")
async def endpoint_function():
    pass
```

### Service íŒŒì¼ (`{service}/app/features/**/service.py`)
- **ì—­í• **: ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì²˜ë¦¬ ë° ì™¸ë¶€ ì„œë¹„ìŠ¤ í˜¸ì¶œ
- **í•„ìˆ˜ í¬í•¨**: í•˜ë‚˜ ì´ìƒì˜ ì„œë¹„ìŠ¤ í•¨ìˆ˜ ë˜ëŠ” í´ë˜ìŠ¤
- **í‘œì¤€ êµ¬ì¡°**:
```python
from typing import Optional
import httpx

class FeatureService:
    def __init__(self):
        self.external_client = httpx.AsyncClient()
    
    async def process(self, data: dict) -> dict:
        # ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ êµ¬í˜„
        pass
```

### Schema íŒŒì¼ (`{service}/app/features/**/schema.py`)
- **ì—­í• **: ìš”ì²­/ì‘ë‹µ ë°ì´í„° ê²€ì¦ ë° ì„œë¹„ìŠ¤ ê°„ í†µì‹  ìŠ¤í‚¤ë§ˆ
- **í•„ìˆ˜ í¬í•¨**: Pydantic BaseModel
- **í‘œì¤€ êµ¬ì¡°**:
```python
from pydantic import BaseModel
from typing import List, Optional

class RequestSchema(BaseModel):
    pass

class ResponseSchema(BaseModel):
    pass
```

### Main íŒŒì¼ (`{service}/app/main.py`)
- **ì—­í• **: FastAPI ì• í”Œë¦¬ì¼€ì´ì…˜ ì§„ì…ì 
- **í•„ìˆ˜ í¬í•¨**: FastAPI ì¸ìŠ¤í„´ìŠ¤ì™€ ë¼ìš°í„° ë“±ë¡
- **í‘œì¤€ êµ¬ì¡°**:
```python
from fastapi import FastAPI
from app.features.feature_name.router import router as feature_router

app = FastAPI(
    title="{Service Name} API",
    description="{Service description}",
    version="1.0.0"
)

app.include_router(feature_router)

@app.get("/")
async def root():
    return {"service": "{service-name}", "status": "running"}
```

## âœ… ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ê°œë°œ ê·œì¹™

### 1. ì„œë¹„ìŠ¤ë³„ ë…ë¦½ì„± ìœ ì§€
- ê° ì„œë¹„ìŠ¤ëŠ” ë…ë¦½ì ìœ¼ë¡œ ë°°í¬ ê°€ëŠ¥í•´ì•¼ í•¨
- ì„œë¹„ìŠ¤ ê°„ í†µì‹ ì€ HTTP APIë¥¼ í†µí•´ì„œë§Œ ì§„í–‰
- ê³µìœ  ë°ì´í„°ë² ì´ìŠ¤ ê¸ˆì§€ (ì„œë¹„ìŠ¤ë³„ ë…ë¦½ì  ë°ì´í„° ì €ì¥ì†Œ)

### 2. ê³µí†µ ë„¤ì´ë° ì»¨ë²¤ì…˜
- Features ë””ë ‰í† ë¦¬ëª…: ì†Œë¬¸ì, ì–¸ë”ìŠ¤ì½”ì–´ ì‚¬ìš©
- íŒŒì¼ëª…: í‘œì¤€ íŒŒì¼ëª… ì‚¬ìš© (`router.py`, `service.py` ë“±)
- í´ë˜ìŠ¤ëª…: PascalCase (ì˜ˆ: `EmbeddingService`)
- í•¨ìˆ˜ëª…: snake_case (ì˜ˆ: `generate_embedding`)

### 3. ì„œë¹„ìŠ¤ ê°„ í†µì‹  íŒ¨í„´
```python
# app/core/http_client.py
import httpx
from app.core.config import settings

class ServiceClient:
    def __init__(self):
        self.embedding_client = httpx.AsyncClient(base_url=settings.EMBEDDING_SERVER_URL)
        self.llm_client = httpx.AsyncClient(base_url=settings.LLM_SERVER_URL)
        self.vector_client = httpx.AsyncClient(base_url=settings.VECTOR_DB_URL)
```

### 4. í™˜ê²½ ì„¤ì • ê´€ë¦¬
ê° ì„œë¹„ìŠ¤ëŠ” ë…ë¦½ì ì¸ í™˜ê²½ ì„¤ì •ì„ ê°€ì ¸ì•¼ í•©ë‹ˆë‹¤:
```python
# app/core/config.py
from pydantic import BaseSettings

class Settings(BaseSettings):
    # ì„œë¹„ìŠ¤ ê¸°ë³¸ ì„¤ì •
    HOST: str = "0.0.0.0"
    PORT: int = 8000
    
    # ì™¸ë¶€ ì„œë¹„ìŠ¤ URL
    EMBEDDING_SERVER_URL: str = "http://embedding-server:8001"
    LLM_SERVER_URL: str = "http://llm-server:8002"
    VECTOR_DB_URL: str = "http://vector-db:6333"
    
    class Config:
        env_file = ".env"
```

### 5. í—¬ìŠ¤ì²´í¬ í‘œì¤€í™”
ëª¨ë“  ì„œë¹„ìŠ¤ëŠ” ë™ì¼í•œ í—¬ìŠ¤ì²´í¬ ì¸í„°í˜ì´ìŠ¤ë¥¼ ì œê³µí•´ì•¼ í•©ë‹ˆë‹¤:
```python
@router.get("/health")
async def health_check():
    return {
        "status": "healthy",
        "service": "{service-name}",
        "timestamp": datetime.utcnow()
    }
```

## ğŸ³ Docker ì„¤ì • ê·œì¹™

### 1. í‘œì¤€ Dockerfile
ëª¨ë“  ì„œë¹„ìŠ¤ëŠ” ë™ì¼í•œ Dockerfile íŒ¨í„´ì„ ì‚¬ìš©:
```dockerfile
FROM python:3.11-slim

WORKDIR /app

COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY app/ ./app/

EXPOSE 8000

CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000"]
```

### 2. ì„œë¹„ìŠ¤ë³„ í¬íŠ¸ í• ë‹¹
- embedding-server: 8001
- llm-server: 8002  
- rag-server: 8000
- vector-db: 6333

## ğŸ§ª í…ŒìŠ¤íŠ¸ êµ¬ì¡° ê·œì¹™

### âš ï¸ **ì¤‘ìš”: ëª¨ë“  í…ŒìŠ¤íŠ¸ëŠ” Docker Compose í™˜ê²½ì—ì„œ ì‹¤í–‰!**

**ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ê°„ í†µì‹ ì´ ìˆëŠ” í…ŒìŠ¤íŠ¸ëŠ” ë°˜ë“œì‹œ Docker Compose í™˜ê²½ì—ì„œ ì‹¤í–‰í•´ì•¼ í•©ë‹ˆë‹¤.**

ê° ì„œë¹„ìŠ¤ëŠ” ë…ë¦½ì ì¸ í…ŒìŠ¤íŠ¸ êµ¬ì¡°ë¥¼ ê°€ì ¸ì•¼ í•©ë‹ˆë‹¤:
```
{service}/tests/
â”œâ”€â”€ unit/                     â† ë‹¨ìœ„ í…ŒìŠ¤íŠ¸
â”‚   â”œâ”€â”€ features/
â”‚   â”‚   â””â”€â”€ test_{feature}.py
â”‚   â””â”€â”€ core/
â”œâ”€â”€ integration/              â† í†µí•© í…ŒìŠ¤íŠ¸ (ì„œë¹„ìŠ¤ ê°„ í†µì‹ )
â”‚   â””â”€â”€ test_service_integration.py
â”œâ”€â”€ e2e/                      â† End-to-End í…ŒìŠ¤íŠ¸
â”‚   â””â”€â”€ test_api_workflows.py
â””â”€â”€ conftest.py              â† ê³µí†µ fixture
```

### Docker ê¸°ë°˜ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ë°©ë²•

```bash
# 1. Docker Composeë¡œ ëª¨ë“  ì„œë¹„ìŠ¤ ì‹¤í–‰
docker-compose -f docker-compose.dev.yml up -d

# 2. ì„œë¹„ìŠ¤ë“¤ì´ ì¤€ë¹„ë  ë•Œê¹Œì§€ ëŒ€ê¸°
sleep 30

# 3. í…ŒìŠ¤íŠ¸ ì‹¤í–‰
docker-compose exec rag-server pytest tests/
docker-compose exec embedding-server pytest tests/
docker-compose exec llm-server pytest tests/

# 4. í™˜ê²½ ì •ë¦¬
docker-compose -f docker-compose.dev.yml down -v
```

ìì„¸í•œ ë‚´ìš©ì€ [Docker í…ŒìŠ¤íŠ¸ ê°€ì´ë“œ](mdc:.cursor/rules/docker-testing-guide.mdc)ë¥¼ ì°¸ì¡°í•˜ì„¸ìš”.

## ğŸ’¡ ê°œë°œ íŒ

1. **ì„œë¹„ìŠ¤ í…œí”Œë¦¿ í™œìš©**: ìƒˆë¡œìš´ ì„œë¹„ìŠ¤ ì¶”ê°€ ì‹œ ê¸°ì¡´ êµ¬ì¡°ë¥¼ ì°¸ê³ í•˜ì—¬ ì¼ê´€ì„± ìœ ì§€
2. **API ë²„ì „ ê´€ë¦¬**: ëª¨ë“  ì—”ë“œí¬ì¸íŠ¸ì— `/api/v1` prefix ì‚¬ìš©
3. **ë¡œê¹… í‘œì¤€í™”**: ëª¨ë“  ì„œë¹„ìŠ¤ì—ì„œ ë™ì¼í•œ ë¡œê¹… í¬ë§· ì‚¬ìš©
4. **ëª¨ë‹ˆí„°ë§**: ê° ì„œë¹„ìŠ¤ì˜ ì„±ëŠ¥ ë° ìƒíƒœ ëª¨ë‹ˆí„°ë§ êµ¬í˜„
5. **ë¬¸ì„œí™”**: ì„œë¹„ìŠ¤ë³„ API ë¬¸ì„œ ìë™ ìƒì„± ë° ìœ ì§€

ì´ ê·œì¹™ë“¤ì„ ë”°ë¥´ë©´ í™•ì¥ ê°€ëŠ¥í•˜ê³  ìœ ì§€ë³´ìˆ˜ ê°€ëŠ¥í•œ ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ì•„í‚¤í…ì²˜ë¥¼ êµ¬ì¶•í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
