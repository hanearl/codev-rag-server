---
description: 
globs: 
alwaysApply: true
---
# ë°ì´í„°ë² ì´ìŠ¤ íŒ¨í„´ ë° SQLAlchemy ê°€ì´ë“œ

## ğŸ—„ï¸ ë°ì´í„°ë² ì´ìŠ¤ êµ¬ì¡° íŒ¨í„´

### 1. ê¸°ë³¸ ì„¤ì • (`app/db/database.py`)
```python
from sqlalchemy import create_engine
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import sessionmaker
from app.core.config import settings

engine = create_engine(settings.DATABASE_URL)
SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)

Base = declarative_base()

def get_db():
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()
```

### 2. ëª¨ë¸ ì •ì˜ ê·œì¹™ (`app/features/**/model.py`)

#### ê¸°ë³¸ ëª¨ë¸ êµ¬ì¡°
```python
from sqlalchemy import Column, Integer, String, DateTime, Boolean
from sqlalchemy.sql import func
from app.db.database import Base

class User(Base):
    __tablename__ = "users"
    
    # ê¸°ë³¸ í•„ë“œ
    id = Column(Integer, primary_key=True, index=True)
    created_at = Column(DateTime(timezone=True), server_default=func.now())
    updated_at = Column(DateTime(timezone=True), onupdate=func.now())
    is_active = Column(Boolean, default=True)
    
    # ë¹„ì¦ˆë‹ˆìŠ¤ í•„ë“œ
    name = Column(String, nullable=False)
    email = Column(String, unique=True, index=True, nullable=False)
```

#### ê´€ê³„ ì •ì˜
```python
from sqlalchemy import ForeignKey
from sqlalchemy.orm import relationship

class User(Base):
    __tablename__ = "users"
    
    id = Column(Integer, primary_key=True, index=True)
    
    # 1:N ê´€ê³„
    posts = relationship("Post", back_populates="author")

class Post(Base):
    __tablename__ = "posts"
    
    id = Column(Integer, primary_key=True, index=True)
    author_id = Column(Integer, ForeignKey("users.id"))
    
    # ê´€ê³„ ì •ì˜
    author = relationship("User", back_populates="posts")
```

## ğŸ”§ Repository íŒ¨í„´ êµ¬í˜„

### 1. ê¸°ë³¸ Repository í´ë˜ìŠ¤ (`app/core/repository.py`)
```python
from typing import Generic, TypeVar, Type, Optional, List
from sqlalchemy.orm import Session
from app.db.database import Base

ModelType = TypeVar("ModelType", bound=Base)

class BaseRepository(Generic[ModelType]):
    def __init__(self, model: Type[ModelType]):
        self.model = model
    
    def get(self, db: Session, id: int) -> Optional[ModelType]:
        return db.query(self.model).filter(self.model.id == id).first()
    
    def get_multi(self, db: Session, *, skip: int = 0, limit: int = 100) -> List[ModelType]:
        return db.query(self.model).offset(skip).limit(limit).all()
    
    def create(self, db: Session, *, obj_in: dict) -> ModelType:
        db_obj = self.model(**obj_in)
        db.add(db_obj)
        db.commit()
        db.refresh(db_obj)
        return db_obj
    
    def update(self, db: Session, *, db_obj: ModelType, obj_in: dict) -> ModelType:
        for field, value in obj_in.items():
            setattr(db_obj, field, value)
        db.add(db_obj)
        db.commit()
        db.refresh(db_obj)
        return db_obj
    
    def remove(self, db: Session, *, id: int) -> ModelType:
        obj = db.query(self.model).get(id)
        db.delete(obj)
        db.commit()
        return obj
```

### 2. íŠ¹í™”ëœ Repository (`app/features/**/repository.py`)
```python
from typing import Optional
from sqlalchemy.orm import Session
from app.core.repository import BaseRepository
from app.features.users.model import User

class UserRepository(BaseRepository[User]):
    def __init__(self):
        super().__init__(User)
    
    def get_by_email(self, db: Session, *, email: str) -> Optional[User]:
        return db.query(User).filter(User.email == email).first()
    
    def get_active_users(self, db: Session) -> List[User]:
        return db.query(User).filter(User.is_active == True).all()

user_repository = UserRepository()
```

## ğŸ“Š ì¿¼ë¦¬ ìµœì í™” íŒ¨í„´

### 1. Eager Loading ì‚¬ìš©
```python
from sqlalchemy.orm import joinedload

def get_user_with_posts(db: Session, user_id: int) -> Optional[User]:
    return db.query(User)\
        .options(joinedload(User.posts))\
        .filter(User.id == user_id)\
        .first()
```

### 2. í˜ì´ì§€ë„¤ì´ì…˜ êµ¬í˜„
```python
from sqlalchemy import func
from typing import Tuple

def get_users_paginated(
    db: Session, 
    page: int = 1, 
    size: int = 10
) -> Tuple[List[User], int]:
    total = db.query(func.count(User.id)).scalar()
    
    users = db.query(User)\
        .offset((page - 1) * size)\
        .limit(size)\
        .all()
    
    return users, total
```

### 3. ë³µì¡í•œ ì¿¼ë¦¬ ì˜ˆì‹œ
```python
from sqlalchemy import and_, or_, desc

def search_users(
    db: Session,
    search_term: Optional[str] = None,
    is_active: Optional[bool] = None
) -> List[User]:
    query = db.query(User)
    
    # ì¡°ê±´ë¶€ í•„í„°ë§
    if search_term:
        query = query.filter(
            or_(
                User.name.ilike(f"%{search_term}%"),
                User.email.ilike(f"%{search_term}%")
            )
        )
    
    if is_active is not None:
        query = query.filter(User.is_active == is_active)
    
    return query.order_by(desc(User.created_at)).all()
```

## ğŸ—ï¸ ë§ˆì´ê·¸ë ˆì´ì…˜ ê´€ë¦¬ (Alembic)

### 1. ì´ˆê¸° ì„¤ì • (`alembic.ini` ë° `alembic/env.py`)
```python
# alembic/env.py
from app.db.database import Base
from app.features.users.model import User  # ëª¨ë“  ëª¨ë¸ import
from app.features.items.model import Item
# ... ë‹¤ë¥¸ ëª¨ë¸ë“¤

target_metadata = Base.metadata
```

### 2. ë§ˆì´ê·¸ë ˆì´ì…˜ ìƒì„± ê·œì¹™
```bash
# ë§ˆì´ê·¸ë ˆì´ì…˜ ìƒì„±
alembic revision --autogenerate -m "Add users table"

# ë§ˆì´ê·¸ë ˆì´ì…˜ ì ìš©
alembic upgrade head

# íŠ¹ì • ë¦¬ë¹„ì „ìœ¼ë¡œ ë‹¤ìš´ê·¸ë ˆì´ë“œ
alembic downgrade -1
```

### 3. ë§ˆì´ê·¸ë ˆì´ì…˜ íŒŒì¼ ëª…ëª… ê·œì¹™
- `YYYY_MM_DD_HHMM_description.py` í˜•ì‹ ì‚¬ìš©
- ì˜ˆ: `2024_01_15_1400_add_users_table.py`

## ğŸ”’ ë°ì´í„°ë² ì´ìŠ¤ ë³´ì•ˆ íŒ¨í„´

### 1. SQL ì¸ì ì…˜ ë°©ì§€
```python
# âŒ ì˜ëª»ëœ ë°©ë²•
def get_user_by_name(db: Session, name: str):
    return db.execute(f"SELECT * FROM users WHERE name = '{name}'")

# âœ… ì˜¬ë°”ë¥¸ ë°©ë²•
def get_user_by_name(db: Session, name: str):
    return db.query(User).filter(User.name == name).first()
```

### 2. ë¯¼ê°í•œ ë°ì´í„° ì²˜ë¦¬
```python
from sqlalchemy_utils import PasswordType, force_auto_coercion

force_auto_coercion()

class User(Base):
    __tablename__ = "users"
    
    id = Column(Integer, primary_key=True)
    email = Column(String, unique=True, nullable=False)
    # ë¹„ë°€ë²ˆí˜¸ ìë™ í•´ì‹±
    password = Column(PasswordType(schemes=['pbkdf2_sha512']))
```

## ğŸ§ª ë°ì´í„°ë² ì´ìŠ¤ í…ŒìŠ¤íŒ…

### 1. í…ŒìŠ¤íŠ¸ ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì • (`tests/conftest.py`)
```python
import pytest
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker
from app.db.database import Base, get_db
from app.main import app

SQLALCHEMY_DATABASE_URL = "sqlite:///./test.db"

engine = create_engine(SQLALCHEMY_DATABASE_URL, connect_args={"check_same_thread": False})
TestingSessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)

@pytest.fixture
def db():
    Base.metadata.create_all(bind=engine)
    db = TestingSessionLocal()
    try:
        yield db
    finally:
        db.close()
        Base.metadata.drop_all(bind=engine)

@pytest.fixture
def client(db):
    def override_get_db():
        try:
            yield db
        finally:
            db.close()
    
    app.dependency_overrides[get_db] = override_get_db
    yield TestClient(app)
    del app.dependency_overrides[get_db]
```

### 2. Repository í…ŒìŠ¤íŠ¸ ì˜ˆì‹œ
```python
def test_create_user(db):
    user_data = {
        "name": "Test User",
        "email": "test@example.com"
    }
    
    user = user_repository.create(db, obj_in=user_data)
    
    assert user.name == "Test User"
    assert user.email == "test@example.com"
    assert user.id is not None
```

## ğŸ“ˆ ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§

### 1. ì¿¼ë¦¬ ë¡œê¹… ì„¤ì •
```python
import logging

# SQLAlchemy ì¿¼ë¦¬ ë¡œê¹… í™œì„±í™”
logging.getLogger('sqlalchemy.engine').setLevel(logging.INFO)
```

### 2. ì—°ê²° í’€ ì„¤ì •
```python
from sqlalchemy import create_engine

engine = create_engine(
    DATABASE_URL,
    pool_size=10,           # ê¸°ë³¸ ì—°ê²° ìˆ˜
    max_overflow=20,        # ì¶”ê°€ ì—°ê²° ìˆ˜
    pool_pre_ping=True,     # ì—°ê²° ìƒíƒœ í™•ì¸
    pool_recycle=3600       # ì—°ê²° ì¬í™œìš© ì‹œê°„(ì´ˆ)
)
```

ì´ëŸ¬í•œ íŒ¨í„´ë“¤ì„ ë”°ë¥´ë©´ í™•ì¥ ê°€ëŠ¥í•˜ê³  ìœ ì§€ë³´ìˆ˜ ê°€ëŠ¥í•œ ë°ì´í„°ë² ì´ìŠ¤ ê³„ì¸µì„ êµ¬í˜„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
